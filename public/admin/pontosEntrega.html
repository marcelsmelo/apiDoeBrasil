<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="../materialize/css/materialize.min.css"/>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="navbar-fixed container-fluid">
      <nav class="row">
        <div class="nav-wrapper deep-purple darken-1 col s12">
          <a class="waves-effect waves-light left col deep-purple darken-1" id="voltar"><i class="material-icons left large" style="width: 3%; height: 100%;">chevron_left</i></a>
            <a href="index.html" class="brand-logo col center" style="font-size: 1.7em;">
              Doe Brasil
            </a>
          <a class="waves-effect waves-light btn right deep-purple darken-1 col" id="deslogar" style="margin-top: 10px; margin-right: 2%;"> <i class="material-icons left" style="position: relative; bottom:35%;">exit_to_app</i>Sair</a>
        </div>
      </nav>
    </div>

    <div class="container-fluid">
      <div class="row">
         <p class="center" style="color: #0d47a1; font-size: 2em;">
            Pontos Entrega
          </p>
          <div class="row">
            <a href="cadastroPontoEntrega.html" class="waves-effect waves-light btn deep-purple darken-1 col offset-s3 offset-m4 s6 m4"><i class="material-icons left">add</i>Adicionar novo</a> 
          </div>
         <ul class="collection" id="pontosEntrega"></ul>
      </div>
    </div>
  
    <div class="row">
      <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
          <i class="large material-icons">menu</i>
        </a>
        <ul>
          <li><a class="btn-floating blue tooltipped" href="pedidos.html" data-position="left" data-tooltip="Pedidos"><i class="material-icons">favorite</i></a></li>
          <li><a class="btn-floating purple darken-1 tooltipped" href="doacao.html" data-position="left" data-tooltip="Doações"><i class="material-icons">star</i></a></li>
          <li><a class="btn-floating green tooltipped" href="usuarios.html" data-position="left" data-tooltip="Usuários"><i class="material-icons">person</i></a></li>
          <li><a class="btn-floating red tooltipped" href="pontosEntrega.html" data-position="left" data-tooltip="Pontos de Entrega"><i class="material-icons">location_on</i></a></li>
          <li><a class="btn-floating yellow tooltipped" href="meusDados.html" data-position="left" data-tooltip="Editar meus dados"><i class="material-icons">edit</i></a></li>
        </ul>
      </div>
    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="../materialize/js/materialize.min.js"></script>
    <script>
      M.AutoInit();
      window.addEventListener('load', init)

      function init(){
        verificaLogado();
        carregarPontosEntrega()
        M.Tabs.init(document.querySelectorAll('.tabs'),{});
        M.FloatingActionButton.init(document.querySelectorAll('.fixed-action-btn'), {});
        document.querySelector("#deslogar").addEventListener('click', deslogar);
        document.querySelector('#voltar').addEventListener('click', function(){
          window.history.back();
        });
      }

      function verificaLogado(){
        let token = localStorage.getItem('token-partner');
        if(!token) window.location = "/admin/login.html"
      }

      function deslogar(){
        let token = localStorage.getItem('token-partner');
        fetch("/parceiro/logout", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200){
              localStorage.removeItem('token-partner');
              window.location = '/admin/login.html'
            }else if(response.status == 401){
              localStorage.removeItem('token-partner');
              window.location = '/admin/login.html'
            }else if(response.status == 403){
              M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
            }else throw new Error('Erro ao realizar o logout. Tente novamente!')
         })
         .catch((error) => {
          M.toast({html: 'Erro ao realizar o logout. Tente novamente!'});
            console.error(error)
         });
      }

      function carregarPontosEntrega(){
        let token = localStorage.getItem('token-partner')
         let texto = ""
        fetch('/meus-pontos-entrega/', {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200){
              return response.json()
            }else if(response.status == 401){
              localStorage.removeItem('token-partner');
              window.location = '/admin/login.html'
            }else if(response.status == 403){
              M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
            }else throw new Error('Erro ao buscar Pontos de Entrega')
         })
         .then(data=>{
           console.log(data)
           for(let i=0; i<data.length; i++){
               texto += '<li class="collection-item"><div class="card horizontal">'
               texto+='<div class="card-image" style="width: 10px; background-color: orange">'  
               texto += '</div><div class="card-stacked"><div class="card-content">'
               
               texto += `<h5><i class="material-icons left">person</i>${data[i].nome}</h5>`
               texto += `<h6><i class="material-icons left">phone</i>${data[i].telefone}</h6>`
               texto += `<h6><i class="material-icons left">place</i>${data[i].rua} - Nro ${data[i].numero} - ${data[i].bairro} - ${data[i].cidade} - ${data[i].estado}</h6>`
               
               texto += '<div class="row"><div class="col right">'

                texto += `<a class="waves-effect waves-teal btn-flat col" href="/admin/cadastroPontoEntrega.html?id=${data[i].id}"><i class="material-icons left">edit</i>Editar</a>`
               texto += `<a class="waves-effect waves-teal btn-flat col" onclick="removerPontoEntrega(${data[i].id})"><i class="material-icons left">close</i>Remover</a>`
               
               texto += '</div> </div>'
               texto += '</div> </div> </div> </li>'

            }
           
            document.querySelector('#pontosEntrega').innerHTML = texto;
         })
         .catch((error) => {
            M.toast({html: 'Erro ao buscar Pontos de Entrega. Tente novamente!'});
            console.error(error)
         });
      }

      function selecionarUsuario(pontoEntregaId){
        let resp = confirm('Deseja realmente selecionar o usuário como parceiro?')
        if(!resp) return ;

        let token = localStorage.getItem('token-partner');
        fetch("/usuario/parceiro/"+pontoEntregaId, {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
            if(response.status == 200){
              M.toast({html: 'Usuário selecionado com sucesso!'});
              carregarUsuarios('/usuario', localStorage.getItem('token-partner'), document.querySelector('#usuariosCidade'))
            }else if(response.status == 401){
              localStorage.removeItem('token-partner');
              window.location = '/admin/login.html'
            }else if(response.status == 403){
              M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
            }
            else throw new Error('Erro ao selecionar Usuário')
         })
         .catch((error) => {
          M.toast({html: 'Erro ao selecionar Usuário. Tente novamente!'});
            console.error(error)
         });
      }

      function removerPontoEntrega(usuarioId){
        let resp = confirm('Deseja realmente remover o Ponto de Entrega ?')
        if(!resp) return ;

        let token = localStorage.getItem('token-partner');
        fetch("/ponto-entrega/"+usuarioId, {
          method: "DELETE",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
            if(response.status == 200){
              M.toast({html: 'Ponto de Entrega removido com sucesso!'});
              carregarPontosEntrega()
            }else if(response.status == 401){
              localStorage.removeItem('token-partner');
              window.location = '/admin/login.html'
            }else if(response.status == 403){
               M.toast({html: 'O parceiro não tem permissão para essa operação!'})
            }
            else throw new Error('Erro ao remove Ponto de Entrega.')
         })
         .catch((error) => {
          M.toast({html: 'Erro ao remover Ponto de Entrega. Tente novamente!'});
            console.error(error)
         });
      }
    </script>
  </body>
</html>
