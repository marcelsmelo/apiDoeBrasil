<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="navbar-fixed container-fluid">
      <nav class="row">
        <div class="nav-wrapper blue darken-4 col s12">
          <a href="index.html" class="left col s10 center" >
            <img src="logo2.svg" alt="Logo" id="logo" class="center">
          </a>
        </div>
      </nav>
    </div>

    <p class="center" style="color: #0d47a1; font-size: 2em;">
      Cadastro Usuário
    </p>
    <div class="container">
      <div class="row">
        <form class="col s12" name="usuarioForm">
          <div class="row">
            <div class="input-field col s12">
               <i class="material-icons prefix">account_circle</i>
               <input id="nome" type="text" />
               <label for="nome">Nome</label>
            </div>
            <div class="input-field col s12 m6">
               <i class="material-icons prefix">phone</i>
              <input id="telefone" type="text" onkeydown="javascript: fMasc( this, mTel );"/>
              <label for="telefone">Telefone</label>
            </div>
            <div class="input-field col s12 m6">
               <i class="material-icons prefix">lock</i>
              <input id="senha" type="password" />
              <label for="senha">Senha</label>
            </div>
            <div class="input-field col s12 m8">
               <i class="material-icons prefix">place</i>
              <input id="rua" type="text" />
              <label for="rua">Rua</label>
            </div>
            <div class="input-field col s12 m4">
               <i class="material-icons prefix">map</i>
               <input id="numero" type="text" onkeydown="javascript: fMasc( this, mNum);" />
               <label for="numero">Número</label>
             </div>
             <div class="input-field col s12 m6">
               <i class="material-icons prefix">place</i>
               <input id="bairro" type="text" />
               <label for="bairro">Bairro</label>
             </div>
             <div class="input-field col s12 m6">
               <i class="material-icons prefix">view_headline</i>
               <input id="complemento" type="text" />
               <label for="complemento">Complemento</label>
             </div>

             <div class="input-field col s12 m6">
               <i class="material-icons prefix">location_city</i>
               <select id="estado">
                 <option value="" disabled selected>Selecione um Estado</option>
                 <option value="AC">Acre</option>
                 <option value="AL">Alagoas</option>
                 <option value="AM">Amazonas</option>
                 <option value="BA">Bahia</option>
                 <option value="CE">Ceará</option>
                 <option value="DF">Distrito Federal</option>
                 <option value="ES">Espírito Santo</option>
                 <option value="GO">Goiás</option>
                 <option value="MA">Maranhão</option>
                 <option value="MT">Mato Grosso</option>
                 <option value="MS">Mato Grosso do Sul</option>
                 <option value="MG">Minas Gerais</option>
                 <option value="PA">Pará</option>
                 <option value="PB">Paraíba</option>
                 <option value="PR">Paraná</option>
                 <option value="PE">Pernambuco</option>
                 <option value="PI">Piauí</option>
                 <option value="RJ">Rio de Janeiro</option>
                 <option value="RN">Rio Grande do Norte</option>
                 <option value="RS">RIo Grande do Sul</option>
                 <option value="RO">Rondônia</option>
                 <option value="RR">Roraima</option>
                 <option value="SC">Santa Catarina</option>
                 <option value="SP">São Paulo</option>
                 <option value="SE">Sergipe</option>
                 <option value="TO">Tocantins</option>
               </select>
               <label>Estado</label>
             </div>

             <div class="input-field col s12 m6">
               <i class="material-icons prefix">location_city</i>
               <select  id="cidade">
                 <option value="" disabled selected>Selecione uma cidade</option>
               </select>
               <label>Cidade</label>
             </div>
          </div>
          <div class="row">
            <a class="waves-effect waves-light btn blue darken-4 col offset-s3 offset-m4 s6 m4 " id="cadastrar"><i class="material-icons right">send</i>Cadastrar</a>
          </div>
        </form>
      </div>
    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      M.AutoInit();
      window.addEventListener("load", init);

      function init() {
        M.FormSelect.init(document.querySelectorAll('select'), {});
        document.querySelector('#cadastrar').addEventListener('click', cadastrar);
        document.querySelector('#estado').addEventListener('change', carregarCidades);
        refreshSelectElements()
      }

      function refreshSelectElements(){
        let elements = document.querySelectorAll('li[id^="select-options"]')
        for(let i=0; i<elements.length; i++){
          elements[i].addEventListener('touchend', function(e){
            e.stopPropagation();
          })
        }
      }

      function carregarCidades(){
         let form = document.forms['usuarioForm']
         let estadoSelecionado = form.estado.options[form.estado.selectedIndex].value
         let tamanho = form.cidade.options.length
         for(let i=0; i<tamanho; i++){
            form.cidade.options[0] = null
         }

         fetch("/cidades/"+estadoSelecionado, {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
        })
         .then((response) => {
            if(response.status == 200)
               return response.json();
            else
               throw new Error('Erro ao buscar cidades')
         })
         .then((data) => {
            let cidades = data.cidades;
            for(let i=0; i<cidades.length; i++){
               form.cidade.options.add(new Option(cidades[i], cidades[i]))
            }
            M.FormSelect.init(form.cidade)
            refreshSelectElements()
         })
         .catch((error) => {
            M.toast({html: 'Erro ao carregar cidades. Tente novamente!'});
            console.error(error)
         });
      }

      function cadastrar() {
         let form = document.forms['usuarioForm']

         let data = {
            nome: form.nome.value,
            telefone: form.telefone.value,
            senha: form.senha.value,
            rua: form.rua.value,
            numero: form.numero.value,
            bairro: form.bairro.value,
            complemento: form.complemento.value,
            estado: form.estado.options[form.estado.selectedIndex].value,
            cidade: form.cidade.options[form.cidade.selectedIndex].value
        }

        fetch("/usuario", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        })
         .then((response) => {
            if(response.status == 201)
               return response.json();
            else
               throw new Error('Erro ao realizar cadastro. Tente novamente!')
         })
         .then((data) => {
            M.toast({html: 'Parceiro criado com sucesso!'});
            window.location = "/login.html";
         })
         .catch((error) => {
            M.toast({html: 'Erro a criar usuário. Tente novamente!'});
            console.error(error)
         });
      }

      function fMasc(objeto,mascara) {
				obj=objeto
				masc=mascara
				setTimeout("fMascEx()",1)
      }
      function fMascEx() {
				obj.value=masc(obj.value)
			}

      function mTel(tel) {
				tel=tel.replace(/\D/g,"")
				tel=tel.replace(/^(\d)/,"($1")
				tel=tel.replace(/(.{3})(\d)/,"$1) $2")
				if(tel.length == 9) {
					tel=tel.replace(/(.{1})$/,"$1")
				} else  if(tel.length == 10) {
					tel=tel.replace(/(.{2})$/,"$1")
				}else if (tel.length == 11) {
					tel=tel.replace(/(.{2})$/,"-$1")
				} else if (tel.length == 12) {
					tel=tel.replace(/(.{2})$/,"-$1")
				} else if (tel.length == 14) {
					tel=tel.replace(/(.{4})$/,"-$1")
				} else if (tel.length == 13) {
					tel=tel.replace(/(.{4})$/,"-$1")
				} else if (tel.length == 14) {
					tel=tel.replace(/(.{4})$/,"-$1")
          console.log(tel.substring(5,6))
				}else if(tel.length >= 14){
          tel = tel.substring(0, 14);
          tel=tel.replace(/(.{4})$/,"-$1")
        }
				return tel;
			}

      function mNum(num){
				num=num.replace(/\D/g,"")
				return num
			}
    </script>
  </body>
</html>
