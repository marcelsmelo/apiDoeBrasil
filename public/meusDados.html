<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="navbar-fixed container-fluid">
      <nav class="row">
        <div class="nav-wrapper blue darken-4 col s12">
          <a href="index.html" class="left col s8 offset-l1" >
            <img src="logo2.svg" alt="Logo" id="logo">
          </a>
          <a class="waves-effect waves-light btn right  blue darken-4 col s4" id="deslogar" style="margin-top: 10px;"> <i class="material-icons left" style="position: relative; bottom:35%;">exit_to_app</i>Sair</a>
        </div>
      </nav>
    </div>

    <p class="center" style="color: #0d47a1; font-size: 2em;">
      Cadastro Parceiro
    </p>
    <div class="container">
      <div class="row">
        <form class="col s12" name="parceiroForm">
          <div class="row">
            <div class="input-field col s12">
               <i class="material-icons prefix">account_circle</i>
               <input id="nome" type="text" />
               <label for="nome">Nome</label>
            </div>
            <div class="input-field col s12 m6">
               <i class="material-icons prefix">phone</i>
              <input id="telefone" type="text" />
              <label for="telefone">Telefone</label>
            </div>
            <div class="input-field col s12 m6">
               <i class="material-icons prefix">lock</i>
              <input id="senha" type="password" />
              <label for="senha">Senha</label>
            </div>
            <div class="input-field col s12 m8">
               <i class="material-icons prefix">place</i>
              <input id="rua" type="text" />
              <label for="rua">Rua</label>
            </div>
            <div class="input-field col s12 m4">
               <i class="material-icons prefix">map</i>
               <input id="numero" type="text" />
               <label for="numero">Número</label>
             </div>
             <div class="input-field col s12 m6">
               <i class="material-icons prefix">place</i>
               <input id="bairro" type="text" />
               <label for="bairro">Bairro</label>
             </div>
             <div class="input-field col s12 m6">
               <i class="material-icons prefix">view_headline</i>
               <input id="complemento" type="text" />
               <label for="complemento">Complemento</label>
             </div>

             <div class="input-field col s12 m6">
               <i class="material-icons prefix">location_city</i>
               <select id="estado" disabled>
                 <option value="" disabled selected>Selecione um Estado</option>
                 <option value="AC">Acre</option>
                 <option value="AL">Alagoas</option>
                 <option value="AM">Amazonas</option>
                 <option value="BA">Bahia</option>
                 <option value="CE">Ceará</option>
                 <option value="DF">Distrito Federal</option>
                 <option value="ES">Espírito Santo</option>
                 <option value="GO">Goiás</option>
                 <option value="MA">Maranhão</option>
                 <option value="MT">Mato Grosso</option>
                 <option value="MS">Mato Grosso do Sul</option>
                 <option value="MG">Minas Gerais</option>
                 <option value="PA">Pará</option>
                 <option value="PB">Paraíba</option>
                 <option value="PR">Paraná</option>
                 <option value="PE">Pernambuco</option>
                 <option value="PI">Piauí</option>
                 <option value="RJ">Rio de Janeiro</option>
                 <option value="RN">Rio Grande do Norte</option>
                 <option value="RS">RIo Grande do Sul</option>
                 <option value="RO">Rondônia</option>
                 <option value="RR">Roraima</option>
                 <option value="SC">Santa Catarina</option>
                 <option value="SP">São Paulo</option>
                 <option value="SE">Sergipe</option>
                 <option value="TO">Tocantins</option>
               </select>
               <label>Estado</label>
             </div>

             <div class="input-field col s12 m6">
               <i class="material-icons prefix">location_city</i>
               <select  id="cidade" disabled>
                 <option value="" disabled selected>Selecione uma cidade</option>
               </select>
               <label>Cidade</label>
             </div>
          </div>
          <div class="row">
            <a class="waves-effect waves-light btn blue darken-4 col offset-s3 offset-m4 s6 m4 " id="editar"><i class="material-icons right">edit</i>Editar</a>
          </div>
        </form>
      </div>
      <div class="row">
        <div class="fixed-action-btn">
          <a class="btn-floating btn-large red">
            <i class="large material-icons">menu</i>
          </a>
          <ul>
            <li><a class="btn-floating blue tooltipped" href="pedidos.html" data-position="left" data-tooltip="Pedidos"><i class="material-icons">favorite</i></a></li>
            <li><a class="btn-floating purple darken-1 tooltipped" href="doacao.html" data-position="left" data-tooltip="Doações"><i class="material-icons">star</i></a></li>
            <li><a class="btn-floating green tooltipped" href="usuarios.html" data-position="left" data-tooltip="Usuários"><i class="material-icons">person</i></a></li>
            <li><a class="btn-floating red tooltipped" href="pontosEntrega.html" data-position="left" data-tooltip="Pontos de Entrega"><i class="material-icons">location_on</i></a></li>
            <li><a class="btn-floating yellow tooltipped" href="meusDados.html" data-position="left" data-tooltip="Editar meus dados"><i class="material-icons">edit</i></a></li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      M.AutoInit();
      window.addEventListener("load", init);

      function init() {
        verificaLogado();
        carregarDados();
        M.FormSelect.init(document.querySelectorAll('select'), {});
        document.querySelector('#editar').addEventListener('click', editar);
        document.querySelector('#estado').addEventListener('change', carregarCidades);
      }

      function verificaLogado() {
        let token = localStorage.getItem("token");
        if (!token) window.location = "login.html";
      }

      function carregarCidades(){
        return new Promise((resolve, reject)=>{
          let form = document.forms['parceiroForm']
          let estadoSelecionado = form.estado.options[form.estado.selectedIndex].value
          let tamanho = form.cidade.options.length
          for(let i=0; i<tamanho; i++){
            form.cidade.options[0] = null
          }

          fetch("/cidades/"+estadoSelecionado, {
            method: "GET",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
          })
          .then((response) => {
            if(response.status == 200)
               return response.json();
            else
               throw new Error('Erro ao buscar cidades')
          })
          .then((data) => {
            let cidades = data.cidades;
            for(let i=0; i<cidades.length; i++){
              form.cidade.options.add(new Option(cidades[i], cidades[i]))
            }
            M.FormSelect.init(form.cidade)
            resolve(true)
          })
          .catch((error) => {
            alert('Erro ao carregar cidades!')
            console.error(error)
            reject(true)
          });
        })
      }

      function carregarDados(){
        let token = localStorage.getItem("token");
        let form = document.forms['parceiroForm']

        fetch("/parceiro/me/dados", {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          }
        })
        .then((response) => {
          if(response.status == 200)
            return response.json();
          else if(response.status == 401){
            localStorage.removeItem('token');
            window.location = 'login.html'
          }else if(response.status == 403){
            M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
          }else throw new Error('Erro ao realizar cadastro')
        })
        .then((data) => {
          form.nome.value = data.nome
          form.telefone.value = data.telefone
          form.rua.value = data.rua
          form.numero.value = data.numero
          form.bairro.value = data.bairro
          form.complemento.value = data.complemento
          M.updateTextFields();
          let estados = form.estado.options
          for(let i=0; i<estados.length; i++){
            if(estados[i].value == data.estado){
              estados.selectedIndex = i
              
              M.FormSelect.init(form.estado)
            }
          }
          carregarCidades()
          .then(()=>{
            let cidades = form.cidade.options
            for(let i=0; i<cidades.length; i++){
              if(cidades[i].value == data.cidade){
                cidades.selectedIndex = i
                M.FormSelect.init(form.cidade)
                return;
              }
            }
            return;
          })
      })
      .catch((error) => {
        alert('Erro ao salvar dados. Tente novamente!')
        console.error(error)
      });
    }

      function editar() {
         let form = document.forms['parceiroForm']
         let token = localStorage.getItem('token')

         let data = {
            nome: form.nome.value,
            telefone: form.telefone.value,
            senha: form.senha.value,
            rua: form.rua.value,
            numero: form.numero.value,
            bairro: form.bairro.value,
            complemento: form.complemento.value,
            // estado: form.estado.options[form.estado.selectedIndex].value,
            // cidade: form.cidade.options[form.cidade.selectedIndex].value
        }

        fetch("/parceiro", {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
          body: JSON.stringify(data),
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200)
               return response.json();
            else
               throw new Error('Erro ao realizar a edição')
         })
         .then((data) => {
          M.toast({html: 'Parceiro editado com sucesso!'});
          window.location = "/index.html";
         })
         .catch((error) => {
            alert('Erro ao realizar a edição. Tente novamente!')
            console.error(error)
         });
      }
    </script>
  </body>
</html>
