<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="./materialize/css/materialize.min.css"/>

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="navbar-fixed container-fluid">
      <nav class="row">
        <div class="nav-wrapper  blue col s12">
          <a class="waves-effect waves-light left col  blue" id="voltar"><i class="material-icons left large" style="width: 3%; height: 100%;">chevron_left</i></a>
            <a href="index.html" class="brand-logo col center" style="font-size: 1.7em;">
              Doe Brasil
            </a>
          <a class="waves-effect waves-light btn right   blue col" id="deslogar" style="margin-top: 10px; margin-right: 2%;"> <i class="material-icons left" style="position: relative; bottom:35%;">exit_to_app</i>Sair</a>
        </div>
      </nav>
    </div>

    <p class="center" style="color: #0d47a1; font-size: 2em;">
      Realizar Doação
    </p>
    <div class="container">
      <div class="row">
        <form class="col s12" name="doacaoForm">

         <p>
            <label>
              <input type="checkbox" id="alimentacao"/>
              <span><span class="chip orange" style="color: white;"><b>Alimentação</b></span></span>
            </label>
          </p>

          <p>
            <label>
              <input type="checkbox" id="higienePessoal"/>
              <span><span class="chip cyan" style="color: white;"><b>Higiene Pessoal</b></span></span>
            </label>
          </p>

          <p>
            <label>
              <input type="checkbox" id="limpeza"/>
              <span><span class="chip indigo" style="color: white;"><b>Artigo de Limpeza</b></span></span>
            </label>
          </p>

          <p>
            <label>
              <input type="checkbox" id="mascara"/>
              <span><span class="chip green" style="color: white;"><b>Máscara</b></span></span>
            </label>
          </p>

          <br>

          <div class="switch">
            Disponibilidade para entrega?
            <label>
               Não
              <input type="checkbox" id="dispEntrega">
              <span class="lever"></span>
              Sim
            </label>
          </div>

          <div class="row" id="aviso" style="display: none;">   
            <h6 class="red lighten-1" style="color:white; border: 1px solid black; border-radius: 5px; padding: 10px;"><b>Para doações atendendo a um pedido específico, o doador tem que se comprometer com a entrega!</b></h6> 
          </div>
          
          <br>

          <div class="input-field col s12 l6" id="divParceiro">
            <i class="material-icons prefix">location_city</i>
            <select id="parceiro" disabled>
              <option value="" disabled selected>Selecione um parceiro</option>
            </select>
            <label>Parceiro</label>
          </div>

          <div class="input-field col s12 l6" id="divPontoEntrega">
            <i class="material-icons prefix">location_city</i>
            <select id="pontoEntrega" disabled> 
              <option value="" disabled selected>Selecione Ponto de entrega</option>
            </select>
            <label>Ponto entrega</label>
          </div>

          <div class="row">
            <form class="col s12">
              <div class="row">
                <div class="input-field col s12">
                  <i class="material-icons prefix">playlist_add</i>
                  <textarea id="observacao" class="materialize-textarea"></textarea>
                  <label for="observacao">Observações</label>
                </div>
              </div>
            </form>
          </div>
          
          <div class="row">
            <a class="waves-effect waves-light btn teal lighten-2 col offset-s3 offset-m4 s6 m4 " id="cadastrar"><i class="material-icons right">send</i>Cadastrar</a>
          </div>
        </form>
      </div>
      <div class="row">
        <div class="fixed-action-btn">
          <a class="btn-floating btn-large blue">
            <i class="large material-icons">menu</i>
          </a>
          <ul>
            <li><a class="btn-floating red tooltipped" href="index.html" data-position="left" data-tooltip="Tela Inicial"><i class="material-icons">home</i></a></li>
            <li><a class="btn-floating blue tooltipped" href="pedidos.html" data-position="left" data-tooltip="Pedidos"><i class="material-icons">favorite</i></a></li>
            <li><a class="btn-floating purple darken-1 tooltipped" href="doacao.html" data-position="left" data-tooltip="Doações"><i class="material-icons">star</i></a></li>
            <li><a class="btn-floating green tooltipped" href="meusDados.html" data-position="left" data-tooltip="Meus dados"><i class="material-icons">person</i></a></li>
          </ul>
        </div>
      </div>
    <!-- Compiled and minified JavaScript -->
    <script src="./materialize/js/materialize.min.js"></script>
    <script>
      M.AutoInit();
      window.addEventListener("load", init);
      var doacaoId = 0;
      var pedidoId = 0;

      function init(){
        verificaLogado();
        document.querySelector("#deslogar").addEventListener('click', deslogar);
        doacaoId = window.location.search.split('?id=')[1]
        pedidoId = window.location.search.split('?pedidoId=')[1]

        if(doacaoId){
          document.querySelector('#cadastrar').addEventListener('click', editar);
          carregarDados(doacaoId)
          document.querySelector('#cadastrar').innerHTML=`<i class="material-icons right">edit</i>Editar`
        }else{
          
          document.querySelector('#cadastrar').addEventListener('click', cadastrar);
          if(pedidoId){
            
            carregarDadosPedido();
          }
          else carregarParceiros();
        }  
        M.FormSelect.init(document.querySelectorAll('select'), {});
        document.querySelector('#parceiro').addEventListener('change', carregarPontosEntrega);
        document.querySelector('#dispEntrega').addEventListener('change', habilitarSelect);
        refreshSelectElements()

        document.querySelector('#voltar').addEventListener('click', function(){
          window.history.back();
        });
      }

      function habilitarSelect(){
        let form = document.forms['doacaoForm']
        if(this.checked){
          form.parceiro.disabled = false
          M.FormSelect.init(form.parceiro)
          refreshSelectElements();
        }else{
          form.parceiro.disabled = true
          form.parceiro.selectedIndex = 0
          form.pontoEntrega.disabled = true
          form.pontoEntrega.selectedIndex = 0
          M.FormSelect.init(form.parceiro)
          M.FormSelect.init(form.pontoEntrega)
          refreshSelectElements();
        }   
      }

      function verificaLogado() {
        let token = localStorage.getItem("token-user");
        if (!token) window.location = "login.html";
      }

      function deslogar(){
        let token = localStorage.getItem('token-user');
        fetch("/usuario/logout", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200){
              localStorage.removeItem('token-user');
              window.location = 'login.html'
            }
            else throw new Error('Erro ao deslogar')
         })
         .catch((error) => {
          M.toast({html: 'Erro ao fazer logout. Tente novamente!'});
            console.error(error)
         });
      }

      function carregarParceiros(){
        return new Promise((resolve, reject)=>{
         let form = document.forms['doacaoForm']
            let token = localStorage.getItem("token-user");

            let tamanho = form.parceiro.options.length
            for(let i=0; i<tamanho-1; i++){
               form.parceiro.options[1] = null
            }
         
            fetch("/parceiro", {
            method: "GET",
            headers: {
               Accept: "application/json",
               "Content-Type": "application/json",
               "authorization": token
               },
            })
            .then((response) => {
               if(response.status == 200)
                  return response.json();
               else
                  throw new Error('Erro ao buscar Parceiros')
            })
            .then((data) => {
               for(let i=0; i<data.length; i++){
                  let parceiro = data[i]
                  form.parceiro.options.add(new Option(parceiro.nome, parceiro.id))
               }
               M.FormSelect.init(form.parceiro)
               refreshSelectElements();
               resolve(true)
            })
            .catch((error) => {
               M.toast({html: 'Erro ao carregar parceiros. Tente novamente!'});
               reject(true)
               console.error(error)
            });
        })
      }

      function carregarPontosEntrega(){
        return new Promise((resolve, reject)=>{
          let form = document.forms['doacaoForm']
          let parceiroId = form.parceiro.options[form.parceiro.selectedIndex].value;
         let token = localStorage.getItem("token-user");

         let tamanho = form.pontoEntrega.options.length
         for(let i=0; i<tamanho-1; i++){
            form.pontoEntrega.options[1] = null
         }

         fetch("/ponto-entrega/parceiro/"+parceiroId, {
            method: "GET",
            headers: {
               Accept: "application/json",
               "Content-Type": "application/json",
               "authorization": token
               },
            })
            .then((response) => {
               if(response.status == 200)
                  return response.json();
               else
                  throw new Error('Erro ao buscar Pontos de Entrega')
            })
            .then((data) => {
               for(let i=0; i<data.length; i++){
                  let pontoEntrega = data[i]
                  form.pontoEntrega.options.add(new Option(pontoEntrega.nome, pontoEntrega.id))
               }
               form.pontoEntrega.disabled = false
               M.FormSelect.init(form.pontoEntrega)
               refreshSelectElements();
               resolve(true)
            })
            .catch((error) => {
               M.toast({html: 'Erro ao carregar Pontos de Entrega. Tente novamente!'});
               console.error(error)
               reject(true)
            });
        }); 
      }

      function carregarDados(){
        let token = localStorage.getItem("token-user");
        let form = document.forms['doacaoForm']

        fetch("/doacao/"+doacaoId, {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          }
        })
        .then((response) => {
          if(response.status == 200)
            return response.json();
          else if(response.status == 401){
            localStorage.removeItem('token-user');
            window.location = 'login.html'
          }else if(response.status == 403){
            M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
          }else throw new Error('Erro ao buscar doação. Tente novamente!')
        })
        .then((data) => {
          form.alimentacao.checked = data.generoAlimenticio
          form.higienePessoal.checked = data.higienePessoal
          form.limpeza.checked = data.artigoLimpeza
          form.mascara.checked = data.mascara
          form.observacao.value = data.observacoes
          form.dispEntrega.checked = data.dispEntrega
          M.updateTextFields();

          if(data.pedido){
            form.alimentacao.disabled = true
            form.higienePessoal.disabled = true
            form.limpeza.disabled = true
            form.mascara.disabled = true
            form.dispEntrega.disabled = true
            M.updateTextFields();   

            document.querySelector("#aviso").style.display = "block"
            
            document.querySelector("#divParceiro").style.display = 'none'
            document.querySelector("#divPontoEntrega").style.display = 'none'
          }else{
            if(data.parceiro){
            carregarParceiros()
            .then(()=>{
              let parceiros = form.parceiro.options
            for(let i=0; i<parceiros.length; i++){
              if(parceiros[i].value == data.parceiro.id){
                form.parceiro.disabled = false
                parceiros.selectedIndex = i
                M.FormSelect.init(form.parceiro)
                refreshSelectElements()
              }
            }

            carregarPontosEntrega()
              .then(()=>{
                let pontosEntrega = form.pontoEntrega.options
                for(let i=0; i<pontosEntrega.length; i++){
                  if(pontosEntrega[i].value == data.pontoEntrega.id){
                    pontosEntrega.selectedIndex = i
                    console.log(i)
                    M.FormSelect.init(form.pontoEntrega)
                    refreshSelectElements()
                  }
                }
              })
            })
          }
        }
         
        }) 
        .catch((error) => {
            alert('Erro ao salvar dados. Tente novamente!')
            console.error(error)
         }); 
      }


      function carregarDadosPedido(){
        let token = localStorage.getItem("token-user");
        let form = document.forms['doacaoForm']

        fetch("/pedido/"+pedidoId, {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          }
        })
        .then((response) => {
          if(response.status == 200)
            return response.json();
          else if(response.status == 401){
            localStorage.removeItem('token-user');
            window.location = 'login.html'
          }else if(response.status == 403){
            M.toast({html: 'O usuário logado não tem acesso a esta operação!'});
          }else throw new Error('Erro ao buscar dados do Pedido. Tente novamente!')
        })
        .then((data) => {
          console.log('DATA', data)
          form.alimentacao.checked = data.generoAlimenticio
          form.higienePessoal.checked = data.higienePessoal
          form.limpeza.checked = data.artigoLimpeza
          form.mascara.checked = data.mascara
          form.dispEntrega.checked = true

          form.alimentacao.disabled = true
          form.higienePessoal.disabled = true
          form.limpeza.disabled = true
          form.mascara.disabled = true
          form.dispEntrega.disabled = true
          M.updateTextFields();   

          document.querySelector("#aviso").style.display = "block"
          
          document.querySelector("#divParceiro").style.display = 'none'
          document.querySelector("#divPontoEntrega").style.display = 'none'


        }) 
        .catch((error) => {
            alert('Erro ao salvar dados. Tente novamente!')
            console.error(error)
         }); 
      }

      function cadastrar(){
         let form = document.forms['doacaoForm']
         let token = localStorage.getItem('token-user')

         let data = {
            generoAlimenticio: form.alimentacao.checked,
            higienePessoal: form.higienePessoal.checked,
            artigoLimpeza: form.limpeza.checked,
            mascara: form.mascara.checked, 
            observacoes: form.observacao.value,
            dispEntrega: form.dispEntrega.checked
         }

         if(pedidoId) data.pedidoId = pedidoId

         if(!pedidoId && data.dispEntrega){
            parceiroIndex = form.parceiro.selectedIndex
            pontoEntregaIndex =  form.pontoEntrega.selectedIndex      
            
            if(parceiroIndex){
               data.parceiroId = form.parceiro.options[parceiroIndex].value;
               if(pontoEntregaIndex) data.pontoEntregaId = form.pontoEntrega.options[pontoEntregaIndex].value;
               else M.toast({html: 'Selecione um Ponto de Entrega!'});
            }else M.toast({html: 'Selecione um Parceiro!'});
         }

         fetch("/doacao", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
          body: JSON.stringify(data),
        })
         .then((response) => {
            if(response.status == 200)
               return response.json();
            else
               throw new Error('Erro ao cadastrar Doação. Tente novamente!')
         })
         .then((data) => {
            M.toast({html: 'Doação criada com sucesso!'});
            window.location = "/doacao.html";
         })
         .catch((error) => {
            M.toast({html: 'Erro ao cadastrar Doação. Tente novamente!'});
            console.error(error)
         });
      }

      function editar(){
        let form = document.forms['doacaoForm']
         let token = localStorage.getItem('token-user')

         let data = {
            generoAlimenticio: form.alimentacao.checked,
            higienePessoal: form.higienePessoal.checked,
            artigoLimpeza: form.limpeza.checked,
            mascara: form.mascara.checked, 
            observacoes: form.observacao.value
         }

         fetch("/doacao/"+doacaoId, {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
          body: JSON.stringify(data),
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200)
               return response.json();
            else
               throw new Error('Erro ao editar doação. Tente novamente!')
         })
         .then((data) => {
            M.toast({html: 'Doação editada com sucesso!'});
            window.location = "/doacao.html";
         })
         .catch((error) => {
            M.toast({html: 'Erro ao editar doação. Tente novamente!'});
            console.error(error)
         });
      }

      function refreshSelectElements(){
        let elements = document.querySelectorAll('li[id^="select-options"]')
        for(let i=0; i<elements.length; i++){
          elements[i].addEventListener('touchend', function(e){
            e.stopPropagation();
          })
        }
      }

    </script>