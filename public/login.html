<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>

  <body>
   <div class="navbar-fixed">
      <nav>
        <div class="nav-wrapper blue darken-4">

        </div>
      </nav>
    </div>

    <div class="container">
        <br><br>
         <div class="row ">
            <div class="col offset-m3 s12 m6">
              <div class="card hoverable">
                <div class="row">
                  <div class="card-content white-text">
                    <img src="logo3.svg" alt="Logo" style="width: 60%; margin-left: 20%;" class="center">
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s10 offset-s1">
                    <input id="telefone" type="text" class="validate" onkeydown="javascript: fMasc( this, mTel );" onblur="javascript: fMasc( this, mTel );">
                    <label for="telefone">Telefone</label>
                  </div>
                </div>
                <div class="row">
                  <div class="input-field col s10 offset-s1">
                    <input id="senha" type="password" class="validate">
                    <label for="senha">Senha</label>
                  </div>
                </div>
                <div class="row">
                  <a class="waves-effect waves-light btn blue darken-4 col s6 m4 offset-s3 offset-m4 " id="logar"><i class="material-icons right">send</i>Logar</a>
                </div>
                
                <p class="center" style="color: #0d47a1">Não possui uma conta? <a href="cadastroUsuario.html">Cadastre-se como usuário</a></p>
                <br>  
              </div>
              </div>
            </div>
         </div>

    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
       M.AutoInit();
      window.addEventListener('load', init)

      function init(){
        verificaLogado();
        document.querySelector('#logar').addEventListener('click', logar);
      }

      function verificaLogado(){
        let token = localStorage.getItem('token-user');
        if(token) window.location = "index.html";
      }

      function logar(){
         let telefone = document.querySelector('#telefone').value;
         let senha = document.querySelector('#senha').value;
      
         fetch('/usuario/login',{
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
               telefone: telefone,
               senha: senha
            })
         })
         .then(response =>{
            return response.json()
         })
         .then(data =>{
            let token = data.token
            if(token){
               localStorage.setItem('token-user', data.token)
               window.location = "index.html"
            }else{
              M.toast({html: data.msg});
            }
         })
         .catch(error=>{
            M.toast({html: 'Erro ao realizar login. Tente novamente!'});
            console.error('ERROR ', error)
         })
      }

      var obj, masc

      function fMasc(objeto,mascara) {
				obj=objeto
				masc=mascara
				setTimeout("fMascEx()",1)
      }

      function fMascEx() {
				obj.value=masc(obj.value)
			}

      function mTel(tel) {
				tel=tel.replace(/\D/g,"")
				tel=tel.replace(/^(\d)/,"($1")
				tel=tel.replace(/(.{3})(\d)/,"$1) $2")
				if(tel.length == 9) {
					tel=tel.replace(/(\d{1})$/,"$1")
				} else  if(tel.length == 10) {
					tel=tel.replace(/(\d{1})$/,"-$1")
				}else if (tel.length == 11) {
					tel=tel.replace(/(\d{2})$/,"-$1")
				} else if (tel.length == 12) {
					tel=tel.replace(/(\d{3})$/,"-$1")
				} else if (tel.length == 13) {
					tel=tel.replace(/(\d{4})$/,"-$1")
				} else if (tel.length == 14) {
          tel = tel.substring(0, 14);
					tel=tel.replace(/(\d{4})$/,"-$1")
				}else if(tel.length >= 14){
          tel = tel.substring(0, 14);
          tel=tel.replace(/(\d{4})$/,"-$1")
        }
				return tel;
			}

    </script>
  </body>
</html>
