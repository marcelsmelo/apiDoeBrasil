<!DOCTYPE html>
<html>
  <head>
    <!--Import Google Icon Font-->
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Compiled and minified CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <div class="navbar-fixed container-fluid">
      <nav class="row">
        <div class="nav-wrapper blue darken-4 col s12">
          <a href="index.html" class="logo left col offset-l1" >
            <img src="logo2.svg" alt="Logo" style="width: 90%; height:60px;">
          </a>
          <a class="waves-effect waves-light btn right  blue darken-4" id="deslogar" style="margin-top: 10px;"> <i class="material-icons left" style="position: relative; bottom:35%;">exit_to_app</i>Sair</a>
        </div>
      </nav>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li id="tab1" class="tab col s3 m3"><a class="active" href="#test1"><i class="material-icons">add_to_queue</i><span> DISPONÍVEIS</span></a></li>
            <li id="tab2" class="tab col s2 m2"><a href="#test2"><i class="material-icons">airport_shuttle</i><span> RETIRADAS</span></a></li>
            <li id="tab3" class="tab col s2 m2"><a href="#test3"><i class="material-icons">get_app</i><span> ENTREGAS</span></a></li>
            <li id="tab4" class="tab col s2 m2"><a href="#test4"><i class="material-icons">spellcheck</i><span> CONFIRMAR</span></a></li>
            <li id="tab5" class="tab col s3 m3"><a href="#test5"><i class="material-icons">check</i><span> FINALIZADAS</span></a></li>
          </ul>
        </div>
      </div>
      <br>
      <div class="row">
        <div id="test1" class="col s12">
            <h3 class="header center">Doações disponíveis</h3>
            <ul class="collection" id="disponivel"></ul>
        </div>
       
        <div id="test2" class="col s12">
          <h3 class="header center">Minhas Retiradas</h3>
          <ul class="collection" id="retirada"></ul>
        </div>
       
        <div id="test3" class="col s12">
          <h3 class="header center">Entregas <br>Pontos de Entrega</h3>
          <ul class="collection" id="entrega"></ul>
        </div>
       
        <div id="test4" class="col s12">
          <h3 class="header center">Confirmar Entrega</h3>
          <ul class="collection" id="confirmacao"></ul>
        </div>
       
        <div id="test5" class="col s12">
          <h3 class="header center">Doações Finalizadas</h3>
          <ul class="collection" id="finalizada"></ul>
        </div>
       
      </div>
    </div>
    <div class="row">
      <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
          <i class="large material-icons">menu</i>
        </a>
        <ul>
          <li><a class="btn-floating blue tooltipped" href="pedidos.html" data-position="left" data-tooltip="Pedidos"><i class="material-icons">favorite</i></a></li>
          <li><a class="btn-floating purple darken-1 tooltipped" href="doacao.html" data-position="left" data-tooltip="Doações"><i class="material-icons">star</i></a></li>
          <li><a class="btn-floating green tooltipped" href="usuarios.html" data-position="left" data-tooltip="Usuários"><i class="material-icons">person</i></a></li>
          <li><a class="btn-floating red tooltipped" href="pontosEntrega.html" data-position="left" data-tooltip="Pontos de Entrega"><i class="material-icons">location_on</i></a></li>
          <li><a class="btn-floating yellow tooltipped" href="meusDados.html" data-position="left" data-tooltip="Editar meus dados"><i class="material-icons">edit</i></a></li>
        </ul>
      </div>
    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
      M.AutoInit();
      window.addEventListener('load', init)

      function init(){
        verificaLogado();
        carregarDoacao('/parceiro/doacao/disponivel', localStorage.getItem('token'), document.querySelector('#disponivel'))
        M.Tabs.init(document.querySelectorAll('.tabs'),{swipeable: false});
        M.FloatingActionButton.init(document.querySelectorAll('.fixed-action-btn'), {});
        document.querySelector("#deslogar").addEventListener('click', deslogar);
        document.querySelector('#tab1').addEventListener('click', load)
        document.querySelector('#tab2').addEventListener('click', load)
        document.querySelector('#tab3').addEventListener('click', load)
        document.querySelector('#tab4').addEventListener('click', load)
        document.querySelector('#tab5').addEventListener('click', load)
      }

      function load(param){
        let token = localStorage.getItem('token');
        let url = "";
        let componente = {};
        switch(this.id){
          case 'tab1':
            url = "/parceiro/doacao/disponivel"
            componente = document.querySelector('#disponivel')
            break;
          case 'tab2':
            url = "/doacao/status/1"
            componente = document.querySelector('#retirada')
            break;
          case 'tab3':
            url = "/doacao/status/0"
            componente = document.querySelector('#entrega')
            break;
          case 'tab4':
            url = "/doacao/status/2"
            componente = document.querySelector('#confirmacao')
            break;
          case 'tab5':
            url = "/doacao/status/3"
            componente = document.querySelector('#finalizada')
            break;
        }
        carregarDoacao(url, token, componente)
      }

      function verificaLogado(){
        let token = localStorage.getItem('token');
        if(!token) window.location = "login.html"
      }

      function deslogar(){
        let token = localStorage.getItem('token');
        fetch("/parceiro/logout", {
          method: "POST",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200){
              localStorage.removeItem('token');
              window.location = 'login.html'
            }else if(response.status == 401){
              localStorage.removeItem('token');
              window.location = 'login.html'
            }
            else throw new Error('Erro ao deslogar')
         })
         .catch((error) => {
            alert('Erro ao deslogar. Tente novamente!')
            console.error(error)
         });
      }

      function carregarDoacao(url, token, componente){
        let texto = ""
        fetch(url, {
          method: "GET",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
           console.log(response)
            if(response.status == 200){
              return response.json()
            }else if(response.status == 401){
              localStorage.removeItem('token');
              window.location = 'login.html'
            }
            else throw new Error('Erro ao buscar Doações')
         })
         .then(data=>{
           console.log(data)
           for(let i=0; i<data.length; i++){
              texto += '<li class="collection-item"><div class="card horizontal">'
              if(data[i].status == 1 && !data[i].parceiroId) texto+='<div class="card-image" style="width: 10px; background-color: red">'
              else if(data[i].status == 2) texto+='<div class="card-image" style="width: 10px; background-color: yellow">'
              else if(data[i].status != 3 ) texto+='<div class="card-image" style="width: 10px; background-color: blue">'
              else texto+='<div class="card-image" style="width: 10px; background-color: green">'
              
              texto += '</div><div class="card-stacked"><div class="card-content">'
              
              if(data[i].status == 1 && !data[i].parceiroId){
                texto += `<a class="waves-effect waves-teal btn-flat right" onclick="selecionarDoacao(${data[i].id})"><i class="material-icons left">check</i>Selecionar</a>`
              }else if(data[i].status == 2 ){
                texto += `<a class="waves-effect waves-teal btn-flat right" onclick="finalizarDoacao(${data[i].id}, ${componente.id})"><i class="material-icons left">close</i>Confirmar</a>`
              }else if(data[i].status != 3 ){
                texto += `<a class="waves-effect waves-teal btn-flat right" onclick="finalizarDoacao(${data[i].id}, ${componente.id})"><i class="material-icons left">close</i>Finalizar</a>`
              }

              texto += `<h5><i class="material-icons left">person</i>${data[i].usuario.nome}</h5>`
              texto += `<h6><i class="material-icons left">phone</i>${data[i].usuario.telefone}</h6>`
              texto += `<h6><i class="material-icons left">place</i>Rua ${data[i].usuario.rua} - Bairro ${data[i].usuario.bairro}</h6>`
              
  
              if(data[i].observacoes){
                texto += `<br><h6><i class="material-icons left">playlist_add</i><b>Observações:</b></h6>
                          <span>${data[i].observacoes}</span>`
              }
                          
              texto += '</div> <div class="card-action">'

              if(data[i].generoAlimenticio) texto += '<div class="chip orange" style="color: white;"><b>Alimentos</b></div>'
              if(data[i].higienePessoal) texto += '<div class="chip indigo" style="color: white;"><b>Limpeza</b></div>'
              if(data[i].artigoLimpeza) texto += '<div class="chip cyan" style="color: white;"><b>Higiene Pessoal</b></div>'
              if(data[i].mascara) texto += '<div class="chip green" style="color: white;"><b>Máscara</b></div>'

              texto += '</div> </div> </div> </li>'
           }
           
            componente.innerHTML = texto;
         })
         .catch((error) => {
            alert('Erro ao buscar Pedidos. Tente novamente!')
            console.error(error)
         });
      }

      function selecionarDoacao(doacaoId){
        let resp = confirm('Deseja realmente selecionar a Doação para retirada?')
        if(!resp) return ;

        let token = localStorage.getItem('token');
        fetch("/parceiro/doacao/selecionar/"+doacaoId, {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
            if(response.status == 200){
              M.toast({html: 'Doação selecionada com sucesso!'});
              carregarDoacao('/parceiro/doacao/disponivel', localStorage.getItem('token'), document.querySelector('#disponivel'))
            }else if(response.status == 401){
              localStorage.removeItem('token');
              window.location = 'login.html'
            }
            else throw new Error('Erro ao selecionar Pedido')
         })
         .catch((error) => {
            alert('Erro ao selecionar Pedido. Tente novamente!')
            console.error(error)
         });
      }

      function finalizarDoacao(doacaoId, tab){
        let resp = confirm('Deseja realmente confirmar recebimento da Doação?')
        if(!resp) return ;

        console.log(tab)
  
        let token = localStorage.getItem('token');
        fetch("/doacao/finalizar/"+doacaoId, {
          method: "PUT",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "authorization": token
          },
        })
         .then((response) => {
            if(response.status == 200){
              M.toast({html: 'Doação finalizada com sucesso!'});
              let url = ''
              if(tab.id == 'retirada') url = '/doacao/status/1'
              else if(tab.id == 'entrega') url = '/doacao/status/0'
              else if(tab.id == 'confirmacao') url = '/doacao/status/2'
              carregarDoacao(url, localStorage.getItem('token'), tab)
            }else if(response.status == 401){
              localStorage.removeItem('token');
              window.location = 'login.html'
            }
            else{
              throw new Error('Erro ao finalizar Pedido')
            } 
         })
         .catch((error) => {
            alert('Erro ao finalizar Pedido. Tente novamente!')
            console.error(error)
         });
      }
    </script>
  </body>
</html>
